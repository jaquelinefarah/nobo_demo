<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Investor Map ‚Äì British Columbia (Demo Data)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 90vh;
      width: 100%;
    }

    /* üîπ Back button */
    #back-button {
      position: absolute;
      top: 15px;
      left: 210px;
      background-color: white;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color: #17193b;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      z-index: 10;
      transition: all 0.2s ease-in-out;
    }

    #back-button:hover {
      background-color: #f2f2f2;
      transform: translateY(-1px);
    }

    /* üîπ Floating title */
    h3 {
      position: absolute;
      top: 60px;
      left: 15px;
      background: rgba(255,255,255,0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 16px;
      color: #17193b;
      z-index: 9;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      margin: 0;
    }

    /* üîπ Filter box */
    #filter-box {
      position: absolute;
      top: 125px;
      left: 10px;
      background: white;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 5;
      line-height: 1.6;
    }

    #filter-box b {
      display: block;
      margin-bottom: 4px;
      color: #17193b;
    }

    #filter-box label {
      display: block;
      margin: 3px 0;
    }

    /* üîπ Legend box */
    .legend {
      background: white;
      padding: 10px;
      margin: 10px;
      font-size: 14px;
      font-family: Arial, sans-serif;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      line-height: 20px;
    }

    .legend img {
      vertical-align: middle;
      margin-right: 6px;
    }

    /* üîπ Counter text */
    #counter {
      margin-top: 8px;
      font-weight: bold;
      text-align: center;
      color: #17193b;
    }
  </style>
</head>

<body>
  <!-- üîπ Back button -->
  <a href="index.html" id="back-button">‚¨Ö Back to Dashboard</a>

  <!-- üîπ Floating title -->
  <h3>Investor Map ‚Äì British Columbia (Demo Data)</h3>

  <!-- üîπ Filter box -->
  <div id="filter-box">
    <b>Show Clusters:</b>
    <label><input type="checkbox" id="clusterTop" checked> Top Priority</label>
    <label><input type="checkbox" id="clusterHigh" checked> High-Potential</label>
    <label><input type="checkbox" id="clusterPotential" checked> Potential</label>
    <label><input type="checkbox" id="clusterLow" checked> Low-Potential</label>
    <label><input type="checkbox" id="clusterPending" checked> Pending Contact Method</label>
    <label><input type="checkbox" id="clusterNon" checked> Do Not Contact</label>
  </div>

  <div id="map"></div>
  <div id="legend" class="legend"><b>Legend</b></div>

  <script>
    async function initMap() {
      const centerBC = { lat: 49.25, lng: -123.1 };
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: centerBC,
      });

      // === PONTOS FIXOS ===
      const airport = { lat: 49.1967, lng: -123.1815 };
      const cityHall = { lat: 49.2609, lng: -123.1139 };

      new google.maps.Marker({
        position: airport,
        map,
        icon: {
          url: "http://maps.google.com/mapfiles/kml/shapes/airports.png",
          scaledSize: new google.maps.Size(40, 40)
        },
        title: "Vancouver International Airport"
      });

      new google.maps.Marker({
        position: cityHall,
        map,
        icon: {
          url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png",
          scaledSize: new google.maps.Size(40, 40)
        },
        title: "Vancouver City Hall"
      });

      // === C√çRCULOS DE DIST√ÇNCIA ===
      new google.maps.Circle({
        strokeColor: "#0000FF",
        strokeOpacity: 0.6,
        strokeWeight: 2,
        fillColor: "#0000FF",
        fillOpacity: 0.1,
        map,
        center: airport,
        radius: 30000 // 30 km
      });

      new google.maps.Circle({
        strokeColor: "#FF0000",
        strokeOpacity: 0.6,
        strokeWeight: 2,
        fillColor: "#FF0000",
        fillOpacity: 0.1,
        map,
        center: cityHall,
        radius: 20000 // 20 km
      });

      // === CARREGAR INVESTIDORES ===
      const response = await fetch("data/nobo_demo_bc.json");
      const investors = await response.json();

      const clusterIcons = {
        "Top Priority Contacts": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        "High-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
        "Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/pink-dot.png",
        "Low-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
        "Pending Contact Method": "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        "Do Not Contact": "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
      };

      const markersByCluster = {};
      for (const cluster in clusterIcons) {
        markersByCluster[cluster] = [];
      }

      // === NORMALIZAR NOMES DE CLUSTER ===
      function normalizeCluster(cluster) {
        if (!cluster) return "Do Not Contact";
        cluster = cluster.toLowerCase();
        if (cluster.includes("top")) return "Top Priority Contacts";
        if (cluster.includes("high")) return "High-Potential Contacts";
        if (cluster.includes("potential") && !cluster.includes("low")) return "Potential Contacts";
        if (cluster.includes("low")) return "Low-Potential Contacts";
        if (cluster.includes("pending")) return "Pending Contact Method";
        if (cluster.includes("not")) return "Do Not Contact";
        return "Do Not Contact";
      }

      // === CRIAR MARCADORES ===
      investors.forEach(inv => {
        if (inv.lat && inv.lon) {
          const clusterClean = normalizeCluster(inv.cluster);
          const iconUrl = clusterIcons[clusterClean] || "http://maps.google.com/mapfiles/ms/icons/gray-dot.png";

          const marker = new google.maps.Marker({
            position: { lat: inv.lat, lng: inv.lon },
            map: map,
            title: `${inv.name} (${inv.city})`,
            icon: iconUrl
          });

          const info = new google.maps.InfoWindow({
            content: `
              <div style="font-size:14px; line-height:1.5; max-width:280px;">
                <b>${inv.name}</b><br>
                <b>City:</b> ${inv.city || "N/A"}<br>
                <b>Province:</b> ${inv.province || "BC"}<br>
                <b>Shares:</b> ${Number(inv.shares).toLocaleString()}<br>
                <b>Tier:</b> ${inv.tier || "N/A"}<br>
                <b>Cluster:</b> ${clusterClean}<br>
                <hr style="margin:6px 0;">
                <b>Regional Data (FSA):</b><br>
                Avg. Income: $${Number(inv.income || 0).toFixed(1)}K<br>
                Avg. Age: ${Math.round(inv.age) || "N/A"} years
                <hr style="margin:6px 0;">
                <b>Distances (from Vancouver):</b><br>
                üõ´ <b>Airport:</b> ${inv.dist_to_airport_km?.toFixed(1) || "N/A"} km ‚Ä¢ ${Math.round(inv.time_to_airport_min) || "N/A"} min<br>
                üèõÔ∏è <b>City Hall:</b> ${inv.dist_to_cityhall_km?.toFixed(1) || "N/A"} km ‚Ä¢ ${Math.round(inv.time_to_cityhall_min) || "N/A"} min
              </div>
            `
          });

          marker.addListener("click", () => info.open(map, marker));
          markersByCluster[clusterClean].push(marker);
        }
      });

      // === LEGENDA ===
      const legend = document.getElementById("legend");
      for (const [cluster, iconUrl] of Object.entries(clusterIcons)) {
        const div = document.createElement("div");
        div.innerHTML = `<img src="${iconUrl}"> ${cluster}`;
        legend.appendChild(div);
      }

      // === CONTADOR DE INVESTIDORES ===
      const counterDiv = document.createElement("div");
      counterDiv.id = "counter";
      legend.appendChild(counterDiv);
      map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);

      function updateCounter() {
        let visibleCount = 0;
        for (const cluster in markersByCluster) {
          markersByCluster[cluster].forEach(marker => {
            if (marker.getVisible()) visibleCount++;
          });
        }
        counterDiv.textContent = `Visible Investors: ${visibleCount}`;
      }

      // === FILTROS ===
      const checkboxes = {
        "Top Priority Contacts": document.getElementById("clusterTop"),
        "High-Potential Contacts": document.getElementById("clusterHigh"),
        "Potential Contacts": document.getElementById("clusterPotential"),
        "Low-Potential Contacts": document.getElementById("clusterLow"),
        "Pending Contact Method": document.getElementById("clusterPending"),
        "Do Not Contact": document.getElementById("clusterNon")
      };

      for (const [cluster, checkbox] of Object.entries(checkboxes)) {
        checkbox.addEventListener("change", () => {
          const visible = checkbox.checked;
          markersByCluster[cluster].forEach(marker => marker.setVisible(visible));
          updateCounter();
        });
      }

      updateCounter();
    }
  </script>

  <!-- üîπ Load Google Maps API -->
  <script src="config.js"></script>
  <script>
    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  </script>
</body>
</html>
